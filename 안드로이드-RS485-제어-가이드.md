# ì•ˆë“œë¡œì´ë“œ ì•±ìœ¼ë¡œ KC868-A6 RS485 ì œì–´í•˜ê¸°

## ğŸ¯ **ê²°ë¡ ë¶€í„° ë§í•˜ë©´: ì™„ì „íˆ ê°€ëŠ¥í•©ë‹ˆë‹¤!**

KC868-A6ëŠ” WiFië¥¼ ì§€ì›í•˜ë¯€ë¡œ ì•ˆë“œë¡œì´ë“œ ì•±ì—ì„œ **ì—¬ëŸ¬ ë°©ë²•**ìœ¼ë¡œ RS485 ë„¤íŠ¸ì›Œí¬ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ› ï¸ **ì œì–´ ë°©ë²•ë“¤**

### **ë°©ë²• 1: REST API ì œì–´** â­ (ê°€ì¥ ê°„ë‹¨)

#### KC868-A6 ì„¤ì • (ESPHome)
```yaml
# KC868-A6 ì›¹ ì„œë²„ + RS485 ì„¤ì •
esphome:
  name: kc868-a6-api
  
wifi:
  ssid: "your-wifi"
  password: "your-password"
  manual_ip:
    static_ip: 192.168.0.100

# ì›¹ ì„œë²„ í™œì„±í™”
web_server:
  port: 80

# RS485 ì„¤ì •
uart:
  - id: rs485_bus
    tx_pin: GPIO27
    rx_pin: GPIO14
    baud_rate: 9600

modbus:
  uart_id: rs485_bus

modbus_controller:
  - id: device_1
    address: 0x01

# REST APIë¡œ ì œì–´í•  ìŠ¤ìœ„ì¹˜ë“¤
switch:
  - platform: modbus_controller
    modbus_controller_id: device_1
    name: "ì›ê²©ë¦´ë ˆì´1"
    id: remote_relay_1
    register_type: coil
    address: 0

  - platform: modbus_controller
    modbus_controller_id: device_1
    name: "ì›ê²©ë¦´ë ˆì´2" 
    id: remote_relay_2
    register_type: coil
    address: 1

# API ì•¡ì…˜ ì •ì˜
api:
  services:
    - service: control_rs485_device
      variables:
        device_id: int
        relay_num: int
        state: bool
      then:
        - if:
            condition:
              lambda: 'return state;'
            then:
              - switch.turn_on: !lambda "return relay_num == 1 ? id(remote_relay_1) : id(remote_relay_2);"
            else:
              - switch.turn_off: !lambda "return relay_num == 1 ? id(remote_relay_1) : id(remote_relay_2);"
```

#### ì•ˆë“œë¡œì´ë“œ ì•± ì½”ë“œ (Java/Kotlin)
```java
// HTTP ìš”ì²­ìœ¼ë¡œ RS485 ì¥ì¹˜ ì œì–´
public class RS485Controller {
    private static final String KC868_IP = "192.168.0.100";
    
    // ë¦´ë ˆì´ ì¼œê¸°
    public void turnOnRelay(int relayNumber) {
        String url = "http://" + KC868_IP + "/switch/remote_relay_" + relayNumber + "/turn_on";
        makeHttpRequest(url, "POST");
    }
    
    // ë¦´ë ˆì´ ë„ê¸°
    public void turnOffRelay(int relayNumber) {
        String url = "http://" + KC868_IP + "/switch/remote_relay_" + relayNumber + "/turn_off";
        makeHttpRequest(url, "POST");
    }
    
    // HTTP ìš”ì²­ ì‹¤í–‰
    private void makeHttpRequest(String url, String method) {
        new Thread(() -> {
            try {
                URL requestUrl = new URL(url);
                HttpURLConnection connection = (HttpURLConnection) requestUrl.openConnection();
                connection.setRequestMethod(method);
                connection.connect();
                
                int responseCode = connection.getResponseCode();
                Log.d("RS485", "Response: " + responseCode);
                
            } catch (Exception e) {
                Log.e("RS485", "Error: " + e.getMessage());
            }
        }).start();
    }
}
```

#### ì•ˆë“œë¡œì´ë“œ ì•¡í‹°ë¹„í‹° ì˜ˆì œ
```java
public class MainActivity extends AppCompatActivity {
    private RS485Controller rs485Controller;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        rs485Controller = new RS485Controller();
        
        // ë¦´ë ˆì´ 1 ì œì–´ ë²„íŠ¼
        Button relay1OnBtn = findViewById(R.id.relay1_on);
        Button relay1OffBtn = findViewById(R.id.relay1_off);
        
        relay1OnBtn.setOnClickListener(v -> {
            rs485Controller.turnOnRelay(1);
            Toast.makeText(this, "ì›ê²© ë¦´ë ˆì´ 1 ì¼œì§", Toast.LENGTH_SHORT).show();
        });
        
        relay1OffBtn.setOnClickListener(v -> {
            rs485Controller.turnOffRelay(1);
            Toast.makeText(this, "ì›ê²© ë¦´ë ˆì´ 1 êº¼ì§", Toast.LENGTH_SHORT).show();
        });
    }
}
```

---

### **ë°©ë²• 2: MQTT ì œì–´** â­â­ (ì‹¤ì‹œê°„ ì–‘ë°©í–¥)

#### KC868-A6 MQTT ì„¤ì •
```yaml
# MQTT ë¸Œë¡œì»¤ ì—°ê²°
mqtt:
  broker: "192.168.0.10"  # MQTT ë¸Œë¡œì»¤ IP
  username: "mqtt_user"
  password: "mqtt_pass"
  topic_prefix: "kc868_a6"

# MQTTë¡œ ì œì–´ ê°€ëŠ¥í•œ ìŠ¤ìœ„ì¹˜
switch:
  - platform: modbus_controller
    modbus_controller_id: device_1
    name: "RS485-Device1-Relay1"
    id: rs485_relay_1
    register_type: coil
    address: 0

# ìƒíƒœ ì„¼ì„œ (ì½ê¸°)
sensor:
  - platform: modbus_controller
    modbus_controller_id: device_1
    name: "RS485-Device1-Temp"
    register_type: holding
    address: 0x0001
    unit_of_measurement: "Â°C"
```

#### ì•ˆë“œë¡œì´ë“œ MQTT í´ë¼ì´ì–¸íŠ¸
```java
// build.gradleì— ì¶”ê°€
// implementation 'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.2.5'

public class MqttController {
    private MqttClient mqttClient;
    private static final String BROKER_URL = "tcp://192.168.0.10:1883";
    private static final String CLIENT_ID = "AndroidApp";
    
    public void connectMqtt() {
        try {
            mqttClient = new MqttClient(BROKER_URL, CLIENT_ID, new MemoryPersistence());
            MqttConnectOptions options = new MqttConnectOptions();
            options.setUserName("mqtt_user");
            options.setPassword("mqtt_pass".toCharArray());
            
            mqttClient.connect(options);
            
            // ìƒíƒœ ìˆ˜ì‹  êµ¬ë…
            mqttClient.subscribe("kc868_a6/sensor/rs485_device1_temp/state", (topic, message) -> {
                String temperature = new String(message.getPayload());
                Log.d("MQTT", "ì˜¨ë„: " + temperature + "Â°C");
                // UI ì—…ë°ì´íŠ¸
            });
            
        } catch (MqttException e) {
            Log.e("MQTT", "ì—°ê²° ì‹¤íŒ¨: " + e.getMessage());
        }
    }
    
    // RS485 ì¥ì¹˜ ì œì–´
    public void controlRS485Device(int deviceId, int relayNum, boolean state) {
        try {
            String topic = "kc868_a6/switch/rs485_device" + deviceId + "_relay" + relayNum + "/command";
            String payload = state ? "ON" : "OFF";
            
            MqttMessage message = new MqttMessage(payload.getBytes());
            mqttClient.publish(topic, message);
            
        } catch (MqttException e) {
            Log.e("MQTT", "ì œì–´ ì‹¤íŒ¨: " + e.getMessage());
        }
    }
}
```

---

### **ë°©ë²• 3: WebSocket ì‹¤ì‹œê°„ ì œì–´** â­â­â­ (ìµœê³  ì„±ëŠ¥)

#### KC868-A6 WebSocket ì„œë²„
```yaml
# ESPHome WebSocket ì§€ì›
web_server:
  port: 80
  include_internal: true
  
# ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼
api:
  
# ì»¤ìŠ¤í…€ ì›¹ì†Œì¼“ ì„œë¹„ìŠ¤
esphome:
  includes:
    - websocket_server.h

# RS485 ì œì–´ í•¨ìˆ˜
globals:
  - id: rs485_command_queue
    type: std::vector<std::string>
    
script:
  - id: process_rs485_command
    parameters:
      command: string
    then:
      - lambda: |
          // RS485 ëª…ë ¹ ì²˜ë¦¬
          if (command == "relay1_on") {
            id(rs485_relay_1).turn_on();
          } else if (command == "relay1_off") {
            id(rs485_relay_1).turn_off();
          }
```

#### ì•ˆë“œë¡œì´ë“œ WebSocket í´ë¼ì´ì–¸íŠ¸
```java
// build.gradleì— ì¶”ê°€
// implementation 'org.java-websocket:Java-WebSocket:1.5.2'

public class WebSocketController extends WebSocketClient {
    
    public WebSocketController() {
        super(URI.create("ws://192.168.0.100:80/ws"));
    }
    
    @Override
    public void onOpen(ServerHandshake handshake) {
        Log.d("WebSocket", "ì—°ê²°ë¨");
    }
    
    @Override
    public void onMessage(String message) {
        Log.d("WebSocket", "ë°›ì€ ë©”ì‹œì§€: " + message);
        // JSON íŒŒì‹±í•˜ì—¬ UI ì—…ë°ì´íŠ¸
        parseRS485Status(message);
    }
    
    @Override
    public void onClose(int code, String reason, boolean remote) {
        Log.d("WebSocket", "ì—°ê²° ì¢…ë£Œ: " + reason);
    }
    
    @Override
    public void onError(Exception ex) {
        Log.e("WebSocket", "ì—ëŸ¬: " + ex.getMessage());
    }
    
    // RS485 ì¥ì¹˜ ì œì–´ ëª…ë ¹ ì „ì†¡
    public void sendRS485Command(String command) {
        if (isOpen()) {
            send("{\"type\":\"rs485_control\",\"command\":\"" + command + "\"}");
        }
    }
    
    private void parseRS485Status(String json) {
        // JSON íŒŒì‹±í•˜ì—¬ RS485 ì¥ì¹˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        try {
            JSONObject obj = new JSONObject(json);
            if (obj.has("rs485_status")) {
                // UI ì—…ë°ì´íŠ¸
                updateUI(obj.getJSONObject("rs485_status"));
            }
        } catch (JSONException e) {
            Log.e("WebSocket", "JSON íŒŒì‹± ì—ëŸ¬: " + e.getMessage());
        }
    }
}
```

---

### **ë°©ë²• 4: Home Assistant ì—°ë™** â­â­ (ê°€ì¥ ì™„ì„±ë„ ë†’ìŒ)

#### KC868-A6 â†’ Home Assistant í†µí•©
```yaml
# Home Assistant API ì—°ë™
api:
  encryption:
    key: "your-api-key"

# Home Assistantì—ì„œ ë³´ì´ëŠ” ì—”í‹°í‹°ë“¤
switch:
  - platform: modbus_controller
    modbus_controller_id: device_1
    name: "ê³µì¥-ë¼ì¸1-ì»¨ë² ì´ì–´"
    id: factory_line1_conveyor
    register_type: coil
    address: 0

  - platform: modbus_controller
    modbus_controller_id: device_1  
    name: "ê³µì¥-ë¼ì¸1-ë¡œë´‡ì•”"
    id: factory_line1_robot
    register_type: coil
    address: 1

sensor:
  - platform: modbus_controller
    modbus_controller_id: device_1
    name: "ê³µì¥-ë¼ì¸1-ì˜¨ë„"
    register_type: holding
    address: 0x0001
    unit_of_measurement: "Â°C"
```

#### ì•ˆë“œë¡œì´ë“œ Home Assistant ì•± API
```java
public class HomeAssistantController {
    private static final String HA_URL = "http://192.168.0.50:8123";
    private static final String ACCESS_TOKEN = "your-long-lived-access-token";
    
    // RS485 ì—°ê²°ëœ ì¥ì¹˜ ì œì–´
    public void controlRS485Entity(String entityId, String action) {
        String url = HA_URL + "/api/services/switch/" + action;
        
        JSONObject data = new JSONObject();
        try {
            data.put("entity_id", entityId);
        } catch (JSONException e) {
            e.printStackTrace();
        }
        
        new Thread(() -> {
            try {
                HttpURLConnection connection = (HttpURLConnection) new URL(url).openConnection();
                connection.setRequestMethod("POST");
                connection.setRequestProperty("Authorization", "Bearer " + ACCESS_TOKEN);
                connection.setRequestProperty("Content-Type", "application/json");
                connection.setDoOutput(true);
                
                OutputStreamWriter writer = new OutputStreamWriter(connection.getOutputStream());
                writer.write(data.toString());
                writer.flush();
                
                int response = connection.getResponseCode();
                Log.d("HA", "ì œì–´ ì‘ë‹µ: " + response);
                
            } catch (Exception e) {
                Log.e("HA", "ì œì–´ ì‹¤íŒ¨: " + e.getMessage());
            }
        }).start();
    }
    
    // ì‹¤ì‹œê°„ ìƒíƒœ ì¡°íšŒ
    public void getRS485Status(String entityId, StatusCallback callback) {
        String url = HA_URL + "/api/states/" + entityId;
        
        new Thread(() -> {
            try {
                HttpURLConnection connection = (HttpURLConnection) new URL(url).openConnection();
                connection.setRequestProperty("Authorization", "Bearer " + ACCESS_TOKEN);
                
                BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = reader.readLine()) != null) {
                    response.append(line);
                }
                
                JSONObject status = new JSONObject(response.toString());
                callback.onStatusReceived(status);
                
            } catch (Exception e) {
                Log.e("HA", "ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: " + e.getMessage());
            }
        }).start();
    }
    
    interface StatusCallback {
        void onStatusReceived(JSONObject status);
    }
}
```

---

## ğŸ“± **ì™„ì„±ëœ ì•ˆë“œë¡œì´ë“œ ì•± ì˜ˆì œ**

### **ë©”ì¸ ì•¡í‹°ë¹„í‹° (ì™„ì „í•œ ì˜ˆì œ)**
```java
public class RS485ControlActivity extends AppCompatActivity {
    private RS485Controller rs485Controller;
    private MqttController mqttController;
    private WebSocketController wsController;
    
    // UI ì»´í¬ë„ŒíŠ¸ë“¤
    private Button relay1On, relay1Off, relay2On, relay2Off;
    private TextView temperatureDisplay, statusDisplay;
    private Switch autoModeSwitch;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_rs485_control);
        
        initializeControllers();
        setupUI();
        connectToKC868();
    }
    
    private void initializeControllers() {
        rs485Controller = new RS485Controller();
        mqttController = new MqttController();
        wsController = new WebSocketController();
    }
    
    private void setupUI() {
        relay1On = findViewById(R.id.relay1_on);
        relay1Off = findViewById(R.id.relay1_off);
        temperatureDisplay = findViewById(R.id.temperature);
        statusDisplay = findViewById(R.id.status);
        
        // ë¦´ë ˆì´ ì œì–´ ë²„íŠ¼ë“¤
        relay1On.setOnClickListener(v -> {
            rs485Controller.turnOnRelay(1);
            updateStatus("ë¦´ë ˆì´ 1 ì¼œì§");
        });
        
        relay1Off.setOnClickListener(v -> {
            rs485Controller.turnOffRelay(1);
            updateStatus("ë¦´ë ˆì´ 1 êº¼ì§");
        });
        
        // ìë™ ëª¨ë“œ ìŠ¤ìœ„ì¹˜
        autoModeSwitch = findViewById(R.id.auto_mode);
        autoModeSwitch.setOnCheckedChangeListener((buttonView, isChecked) -> {
            if (isChecked) {
                startAutoMode();
            } else {
                stopAutoMode();
            }
        });
    }
    
    private void connectToKC868() {
        // MQTT ì—°ê²°
        mqttController.connectMqtt();
        
        // WebSocket ì—°ê²°  
        wsController.connect();
        
        updateStatus("KC868-A6 ì—°ê²° ì¤‘...");
    }
    
    private void updateStatus(String message) {
        runOnUiThread(() -> {
            statusDisplay.setText(message);
            Log.d("RS485", message);
        });
    }
    
    private void startAutoMode() {
        // ìë™ ì œì–´ ë¡œì§
        new Thread(() -> {
            while (autoModeSwitch.isChecked()) {
                try {
                    // ì˜¨ë„ ê¸°ë°˜ ìë™ ì œì–´
                    rs485Controller.turnOnRelay(1);
                    Thread.sleep(5000);
                    rs485Controller.turnOffRelay(1);
                    Thread.sleep(5000);
                } catch (InterruptedException e) {
                    break;
                }
            }
        }).start();
    }
    
    private void stopAutoMode() {
        updateStatus("ìë™ ëª¨ë“œ ì¢…ë£Œ");
    }
}
```

---

## ğŸ¯ **ì‹¤ì œ í™œìš© ì‹œë‚˜ë¦¬ì˜¤**

### **ì‹œë‚˜ë¦¬ì˜¤ 1: ê³µì¥ ê´€ë¦¬ ì•±**
```java
// ìƒì‚°ë¼ì¸ ì œì–´
public void startProductionLine(int lineNumber) {
    // 1ë‹¨ê³„: ì»¨ë² ì´ì–´ ì‹œì‘
    rs485Controller.controlDevice(lineNumber, "conveyor", true);
    
    // 2ë‹¨ê³„: ë¡œë´‡ì•” í™œì„±í™”  
    rs485Controller.controlDevice(lineNumber, "robot_arm", true);
    
    // 3ë‹¨ê³„: í’ˆì§ˆê²€ì‚¬ ì¥ë¹„ ì‹œì‘
    rs485Controller.controlDevice(lineNumber, "quality_check", true);
    
    updateProductionStatus("ë¼ì¸ " + lineNumber + " ê°€ë™ ì‹œì‘");
}
```

### **ì‹œë‚˜ë¦¬ì˜¤ 2: ìŠ¤ë§ˆíŠ¸íŒœ ê´€ë¦¬ ì•±**
```java
// ì˜¨ì‹¤ ìë™ ì œì–´
public void autoGreenhouseControl() {
    // ì˜¨ë„ ì„¼ì„œ ì½ê¸°
    float temperature = rs485Controller.readTemperature(1);
    
    if (temperature > 28.0f) {
        // í™˜ê¸°íŒ¬ ê°€ë™
        rs485Controller.controlDevice(1, "ventilation", true);
        // ê¸‰ìˆ˜ ì‹œìŠ¤í…œ ê°€ë™
        rs485Controller.controlDevice(1, "irrigation", true);
    } else if (temperature < 20.0f) {
        // íˆí„° ê°€ë™
        rs485Controller.controlDevice(1, "heater", true);
    }
}
```

### **ì‹œë‚˜ë¦¬ì˜¤ 3: ë¹Œë”© ê´€ë¦¬ ì•±**
```java
// ì „ì²´ ë¹Œë”© ì¡°ëª… ì œì–´
public void controlBuildingLights(boolean nightMode) {
    for (int floor = 1; floor <= 10; floor++) {
        if (nightMode) {
            // ì•¼ê°„ ëª¨ë“œ: ë³´ì•ˆë“±ë§Œ
            rs485Controller.controlFloor(floor, "security_lights", true);
            rs485Controller.controlFloor(floor, "main_lights", false);
        } else {
            // ë‚® ëª¨ë“œ: ì „ì²´ ì¡°ëª…
            rs485Controller.controlFloor(floor, "main_lights", true);
        }
    }
}
```

---

## ğŸš€ **ê²°ë¡ **

**âœ… ì™„ì „íˆ ê°€ëŠ¥í•©ë‹ˆë‹¤!**

### **ì¶”ì²œ ë°©ë²• ìˆœì„œ:**
1. **REST API** - ê°€ì¥ ê°„ë‹¨, ë¹ ë¥¸ êµ¬í˜„
2. **MQTT** - ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹  í•„ìš”ì‹œ
3. **WebSocket** - ìµœê³  ì„±ëŠ¥ í•„ìš”ì‹œ  
4. **Home Assistant** - ì™„ì„±ë„ ë†’ì€ ì‹œìŠ¤í…œ í•„ìš”ì‹œ

### **ì‹¤ì œ êµ¬í˜„ ë‹¨ê³„:**
1. KC868-A6ì— WiFi + RS485 ì„¤ì •
2. ì•ˆë“œë¡œì´ë“œ ì•±ì—ì„œ HTTP/MQTT í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
3. UI ì œì‘ ë° ì œì–´ ë¡œì§ ì¶”ê°€
4. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ê¸°ëŠ¥ ì¶”ê°€

**ì–´ë–¤ ë°©ë²•ìœ¼ë¡œ êµ¬í˜„í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?** êµ¬ì²´ì ì¸ ì½”ë“œì™€ ì„¤ì •ì„ ë” ìì„¸íˆ ë„ì™€ë“œë¦´ê²Œìš”! ğŸ˜Š 