<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC868-A6 ì‹¤ì‹œê°„ ë””ë²„ê·¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .debug-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .log-container {
            height: 400px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .status-card.on {
            background: #d4edda;
            border-color: #28a745;
        }
        .status-card.off {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .btn-test {
            margin: 5px;
            padding: 8px 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="text-center mb-4">
            <h1 class="text-white">ğŸ”§ KC868-A6 ì‹¤ì‹œê°„ ë””ë²„ê·¸</h1>
            <p class="text-white-50">ìƒíƒœ ë¶ˆì¼ì¹˜ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</p>
        </div>

        <!-- ìƒíƒœ ëª¨ë‹ˆí„°ë§ -->
        <div class="debug-panel">
            <h3><i class="fas fa-chart-line"></i> ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§</h3>
            <div class="row mb-3">
                <div class="col-md-6">
                    <button class="btn btn-success" onclick="startMonitoring()">
                        <i class="fas fa-play"></i> ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    </button>
                    <button class="btn btn-danger" onclick="stopMonitoring()">
                        <i class="fas fa-stop"></i> ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
                    </button>
                    <button class="btn btn-warning" onclick="clearLogs()">
                        <i class="fas fa-trash"></i> ë¡œê·¸ ì§€ìš°ê¸°
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <span id="monitor-status" class="badge bg-secondary">ëŒ€ê¸° ì¤‘</span>
                    <span id="monitor-time" class="badge bg-info">00:00:00</span>
                </div>
            </div>
            
            <div class="status-grid" id="status-grid">
                <!-- ìƒíƒœ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ìˆ˜ë™ í…ŒìŠ¤íŠ¸ -->
        <div class="debug-panel">
            <h3><i class="fas fa-flask"></i> ìˆ˜ë™ í…ŒìŠ¤íŠ¸</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>ê°œë³„ ìŠ¤ìœ„ì¹˜ ì œì–´</h5>
                    <div id="switch-controls"></div>
                </div>
                <div class="col-md-6">
                    <h5>ì—°ê²° í…ŒìŠ¤íŠ¸</h5>
                    <button class="btn btn-primary btn-test" onclick="testConnection()">
                        <i class="fas fa-wifi"></i> ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                    <button class="btn btn-info btn-test" onclick="testAllEndpoints()">
                        <i class="fas fa-search"></i> ëª¨ë“  API í…ŒìŠ¤íŠ¸
                    </button>
                    <button class="btn btn-warning btn-test" onclick="forceStatusCheck()">
                        <i class="fas fa-sync"></i> ê°•ì œ ìƒíƒœ í™•ì¸
                    </button>
                </div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
        <div class="debug-panel">
            <h3><i class="fas fa-terminal"></i> ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div class="log-container" id="log-container">
                <div class="text-center text-muted">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>

        <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸° -->
        <div class="text-center">
            <a href="/" class="btn btn-light btn-lg">
                <i class="fas fa-arrow-left"></i> ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let monitoring = false;
        let monitorInterval = null;
        let startTime = null;
        let switchStates = {};
        let logContainer = document.getElementById('log-container');

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeStatusGrid();
            initializeSwitchControls();
            log('ğŸš€ ë””ë²„ê·¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
        });

        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ff00',
                'warn': '#ffff00', 
                'error': '#ff0000',
                'success': '#00ff88'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || '#00ff00';
            logEntry.innerHTML = `[${now}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function initializeStatusGrid() {
            const grid = document.getElementById('status-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 6; i++) {
                const card = document.createElement('div');
                card.className = 'status-card';
                card.id = `status-card-${i}`;
                card.innerHTML = `
                    <h6>ìŠ¤ìœ„ì¹˜ ${i}</h6>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-secondary" id="status-badge-${i}">í™•ì¸ ì¤‘</span>
                        <small class="text-muted" id="status-time-${i}">-</small>
                    </div>
                    <div class="mt-2">
                        <small>UI: <span id="ui-state-${i}">-</span></small><br>
                        <small>ì„œë²„: <span id="server-state-${i}">-</span></small>
                    </div>
                `;
                grid.appendChild(card);
                switchStates[`ìŠ¤ìœ„ì¹˜${i}`] = 'UNKNOWN';
            }
        }

        function initializeSwitchControls() {
            const container = document.getElementById('switch-controls');
            container.innerHTML = '';
            
            for (let i = 1; i <= 6; i++) {
                const controlGroup = document.createElement('div');
                controlGroup.className = 'mb-2';
                controlGroup.innerHTML = `
                    <label class="form-label">ìŠ¤ìœ„ì¹˜ ${i}</label>
                    <div class="btn-group d-block">
                        <button class="btn btn-sm btn-success" onclick="testSwitch(${i}, 'ON')">ON</button>
                        <button class="btn btn-sm btn-danger" onclick="testSwitch(${i}, 'OFF')">OFF</button>
                        <button class="btn btn-sm btn-info" onclick="checkSingleSwitch(${i})">ìƒíƒœí™•ì¸</button>
                    </div>
                `;
                container.appendChild(controlGroup);
            }
        }

        async function startMonitoring() {
            if (monitoring) return;
            
            monitoring = true;
            startTime = Date.now();
            document.getElementById('monitor-status').textContent = 'ëª¨ë‹ˆí„°ë§ ì¤‘';
            document.getElementById('monitor-status').className = 'badge bg-success';
            
            log('ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘', 'success');
            
            // 1ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
            monitorInterval = setInterval(async () => {
                try {
                    await checkAllStates();
                    updateMonitorTime();
                } catch (error) {
                    log(`âŒ ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: ${error}`, 'error');
                }
            }, 1000);
        }

        function stopMonitoring() {
            if (!monitoring) return;
            
            monitoring = false;
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
            
            document.getElementById('monitor-status').textContent = 'ì¤‘ì§€ë¨';
            document.getElementById('monitor-status').className = 'badge bg-danger';
            
            log('â¹ï¸ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€', 'warn');
        }

        function updateMonitorTime() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('monitor-time').textContent = timeStr;
        }

        async function checkAllStates() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const serverStates = await response.json();
                    
                    for (let i = 1; i <= 6; i++) {
                        const switchKey = `ìŠ¤ìœ„ì¹˜${i}`;
                        const serverState = serverStates[switchKey];
                        const uiState = switchStates[switchKey];
                        
                        // ìƒíƒœ ì—…ë°ì´íŠ¸
                        updateStatusCard(i, serverState, uiState);
                        
                        // ë¶ˆì¼ì¹˜ ê°ì§€
                        if (uiState !== 'UNKNOWN' && serverState !== uiState) {
                            log(`ğŸ”§ ìƒíƒœ ë¶ˆì¼ì¹˜! ìŠ¤ìœ„ì¹˜${i} UI:${uiState} â†’ ì„œë²„:${serverState}`, 'warn');
                            switchStates[switchKey] = serverState;
                        } else {
                            switchStates[switchKey] = serverState;
                        }
                    }
                } else {
                    log(`âŒ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜: ${error}`, 'error');
            }
        }

        function updateStatusCard(switchNum, serverState, uiState) {
            const card = document.getElementById(`status-card-${switchNum}`);
            const badge = document.getElementById(`status-badge-${switchNum}`);
            const timeSpan = document.getElementById(`status-time-${switchNum}`);
            const uiSpan = document.getElementById(`ui-state-${switchNum}`);
            const serverSpan = document.getElementById(`server-state-${switchNum}`);
            
            // ì¹´ë“œ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            card.className = 'status-card';
            if (serverState === 'ON') {
                card.classList.add('on');
                badge.textContent = 'ì¼œì§';
                badge.className = 'badge bg-success';
            } else if (serverState === 'OFF') {
                card.classList.add('off');
                badge.textContent = 'êº¼ì§';
                badge.className = 'badge bg-danger';
            } else {
                badge.textContent = 'ì•Œ ìˆ˜ ì—†ìŒ';
                badge.className = 'badge bg-secondary';
            }
            
            // ì‹œê°„ ì—…ë°ì´íŠ¸
            timeSpan.textContent = new Date().toLocaleTimeString();
            
            // ìƒíƒœ ì •ë³´ ì—…ë°ì´íŠ¸
            uiSpan.textContent = uiState;
            serverSpan.textContent = serverState;
            
            // ë¶ˆì¼ì¹˜ í‘œì‹œ
            if (uiState !== 'UNKNOWN' && serverState !== uiState) {
                uiSpan.style.color = '#ff0000';
                serverSpan.style.color = '#ff0000';
            } else {
                uiSpan.style.color = '#28a745';
                serverSpan.style.color = '#28a745';
            }
        }

        async function testSwitch(switchNum, action) {
            log(`ğŸ® ìŠ¤ìœ„ì¹˜${switchNum} ${action} í…ŒìŠ¤íŠ¸ ì‹œì‘`, 'info');
            
            try {
                // UI ìƒíƒœ ë¨¼ì € ì—…ë°ì´íŠ¸
                switchStates[`ìŠ¤ìœ„ì¹˜${switchNum}`] = action;
                updateStatusCard(switchNum, action, action);
                
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        switch: switchNum,
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… ìŠ¤ìœ„ì¹˜${switchNum} ${action} ì„±ê³µ`, 'success');
                } else {
                    log(`âŒ ìŠ¤ìœ„ì¹˜${switchNum} ${action} ì‹¤íŒ¨`, 'error');
                }
                
                // 2ì´ˆ í›„ ìƒíƒœ ì¬í™•ì¸
                setTimeout(() => checkSingleSwitch(switchNum), 2000);
                
            } catch (error) {
                log(`âŒ ìŠ¤ìœ„ì¹˜${switchNum} ${action} ì˜¤ë¥˜: ${error}`, 'error');
            }
        }

        async function checkSingleSwitch(switchNum) {
            log(`ğŸ” ìŠ¤ìœ„ì¹˜${switchNum} ê°œë³„ ìƒíƒœ í™•ì¸`, 'info');
            await checkAllStates();
        }

        async function testConnection() {
            log('ğŸŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    log('âœ… ì„œë²„ ì—°ê²° ì„±ê³µ', 'success');
                    const data = await response.json();
                    log(`ğŸ“Š ì‘ë‹µ ë°ì´í„°: ${JSON.stringify(data)}`, 'info');
                } else {
                    log(`âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error}`, 'error');
            }
        }

        async function testAllEndpoints() {
            log('ğŸ” ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘', 'info');
            
            const endpoints = [
                '/api/status',
                '/api/switch-names',
                '/api/schedules',
                '/api/logs'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) {
                        log(`âœ… ${endpoint} - ì„±ê³µ`, 'success');
                    } else {
                        log(`âŒ ${endpoint} - ì‹¤íŒ¨ (${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${endpoint} - ì˜¤ë¥˜: ${error}`, 'error');
                }
            }
        }

        async function forceStatusCheck() {
            log('ğŸ”„ ê°•ì œ ìƒíƒœ í™•ì¸ ì‹¤í–‰', 'warn');
            await checkAllStates();
        }

        function clearLogs() {
            logContainer.innerHTML = '<div class="text-center text-muted">ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.</div>';
            log('ğŸ—‘ï¸ ë¡œê·¸ ì´ˆê¸°í™”', 'info');
        }
    </script>
</body>
</html> 